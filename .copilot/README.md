# Destiny 2 MCP Server - Development Setup

## Quick Start

```bash
# Clone and setup
git clone https://github.com/Nadiar/destiny2-mcp-server.git
cd destiny2-mcp-server
npm install

# Create .env file
echo "BUNGIE_API_KEY=your-api-key-here" > .env

# Run development server
npm run dev

# Run tests
npm test

# Build for production
npm run build
```

## Key Files & Directories

- **src/** - TypeScript source code
  - `index.ts` - Main server entry point (VERSION constant)
  - `tools/destiny-tools.ts` - All Destiny 2 API tools
  - `api/bungie-client.ts` - Bungie API client with retry logic
  - `services/` - Manifest cache and logging
- **tests/** - Unit and integration tests
- **dist/** - Compiled JavaScript (generated by `npm run build`)
- **.husky/** - Git hooks for automation
- **.github/workflows/** - CI/CD pipelines
  - `ci.yml` - Runs on every push/PR
  - `release.yml` - Runs on version tags

## Important Commands

```bash
# Development
npm run dev              # Watch mode development server
npm run dev:once         # Single run (useful for testing)

# Testing & Quality
npm test                 # Run unit tests
npm run test:watch      # Watch mode testing
npm run format          # Auto-format code with Prettier
npm run lint            # Check for linting issues
npm run typecheck       # Check TypeScript types

# Building
npm run build           # Compile TypeScript to dist/
npm run prepublishOnly  # Lint → Test → Build (runs before npm publish)

# Docker
docker build -t destiny2-mcp-server:latest .
docker run -e BUNGIE_API_KEY=<key> destiny2-mcp-server:latest
```

## Git Workflow

### Making Changes
1. Create feature branch: `git checkout -b feature/my-feature`
2. Make changes (hooks will auto-format and validate)
3. Commit: `git commit -m "feat: add new feature"`
4. Push: `git push origin feature/my-feature`
5. Create PR

### Version Bumps & Releases
1. Update version: Edit `package.json` version or use `npm version patch`
2. Commit: `git commit -m "chore: bump version to X.Y.Z"`
   - Hook auto-creates tag `vX.Y.Z`
   - Hook syncs `src/index.ts` VERSION constant
3. Push: `git push origin master --tags`
   - GitHub Actions publishes to npm
   - Docker image built and pushed to ghcr.io

### Git Hooks (Automatic)
- **Pre-commit:** Auto-formats code, validates versions
- **Post-commit:** Auto-creates release tags on version bumps

See [GIT-HOOKS.md](.copilot/GIT-HOOKS.md) for full details.

## Project Structure

```
destiny2-mcp-server/
├── src/
│   ├── api/                      # Bungie API client
│   ├── config.ts                 # Configuration management
│   ├── index.ts                  # Main entry point
│   ├── services/                 # Manifest cache, logging
│   ├── tools/                    # MCP tools (Destiny 2 features)
│   └── types/                    # TypeScript type definitions
├── tests/
│   ├── *.test.ts                 # Unit tests
│   └── integration/              # Integration tests
├── .github/workflows/            # CI/CD
│   ├── ci.yml                    # Run on push/PR
│   └── release.yml               # Publish on tag
├── .husky/                       # Git hooks
│   ├── pre-commit
│   ├── post-commit
│   └── scripts/
├── .copilot/                     # Context & documentation
├── docs/                         # Additional documentation
├── Dockerfile                    # Docker build
└── package.json                  # Dependencies & scripts
```

## Configuration

### Environment Variables (.env)
```bash
BUNGIE_API_KEY=your-32-character-hex-key     # Required
LOG_LEVEL=info                                # Optional: debug, info, warn, error
CACHE_TTL_HOURS=24                            # Optional: manifest cache TTL
API_RATE_LIMIT_MS=100                         # Optional: rate limit
API_MAX_RETRIES=3                             # Optional: retry attempts
API_TIMEOUT_MS=30000                          # Optional: request timeout
```

### Version Management
- Source of truth: `package.json` → `"version": "X.Y.Z"`
- Synced automatically: `src/index.ts` → `const VERSION = 'X.Y.Z'`
- Git hook: Pre-commit validates and fixes mismatches
- Release tag: Auto-created as `vX.Y.Z`

## Testing

```bash
# All unit tests
npm test

# Watch mode
npm run test:watch

# With coverage
npm run test:coverage

# Integration tests (requires API key)
npm run test:integration
```

## Docker

### Build
```bash
docker build -t destiny2-mcp-server:latest .
```

### Run
```bash
docker run -e BUNGIE_API_KEY=<your-key> destiny2-mcp-server:latest
```

### With Claude Desktop
```json
{
  "mcpServers": {
    "destiny2": {
      "command": "docker",
      "args": ["run", "-i", "--rm", "-e", "BUNGIE_API_KEY=<key>", "ghcr.io/nadiar/destiny2-mcp-server:latest"]
    }
  }
}
```

## CI/CD

### On Push (ci.yml)
- Tests on Node 18.x, 20.x, 22.x
- TypeScript type checking
- Linting and formatting checks
- Security audit
- Docker build test

### On Tag Release (release.yml)
- Run all tests
- Build and publish to npm (via Trusted Publishers)
- Build and push Docker image to ghcr.io
- Create GitHub release

## Troubleshooting

### Tests failing?
1. Check `.env` file exists with valid API key
2. Run `npm ci` to reinstall exact dependencies
3. Check Node version compatibility (18+)

### Docker build fails?
1. Ensure Docker Desktop is running
2. Check Dockerfile is readable
3. Verify Node version in Dockerfile matches your setup

### Hooks not working?
1. Run `npm install` to reinstall hooks
2. Check `.husky/` directory exists
3. See [GIT-HOOKS.md](.copilot/GIT-HOOKS.md) for full troubleshooting

## Additional Resources

- [README.md](/README.md) - Project overview and API docs
- [GIT-HOOKS.md](.copilot/GIT-HOOKS.md) - Git hook documentation
- [CONTRIBUTING.md](/CONTRIBUTING.md) - Contribution guidelines
- [docs/DOCKER.md](/docs/DOCKER.md) - Docker deployment guide

## Contact & Issues

- GitHub Issues: Report bugs and feature requests
- GitHub Discussions: Ask questions and discuss ideas
- Security: See SECURITY.md for vulnerability reporting
